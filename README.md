🚀 Using OpenTofu + Kubernetes + FastAPI + Grafana + Prometheus + ArgoCD 🚀
Welcome to ter-k8s-api! This repository contains a sample FastAPI application and all the infrastructure as code needed to deploy it on a local Kubernetes cluster (Docker Desktop).

---

```markdown
# 🚀 Using OpenTofu + Kubernetes + FastAPI + Grafana + Prometheus + ArgoCD 🚀

Welcome to **ter-k8s-api**! This repository contains a sample **FastAPI** application and all the infrastructure as code required to deploy it on a local Kubernetes cluster (Docker Desktop).

---

## 📚 Project Overview

This project demonstrates a well-organized directory structure for Python applications using FastAPI, Docker, OpenTofu, and Kubernetes. It includes:

- A simple **FastAPI API** for customer management, supporting **create**, read, update, and delete operations.
- **Interactive API documentation with Swagger UI (OpenAPI)**, auto-generated by FastAPI, enabling easy exploration and testing of endpoints.
- Jinja2 templates and static files for a basic web interface.
- A `Dockerfile` to containerize the application.
- **OpenTofu** modules defining Kubernetes infrastructure, including API deployment, monitoring, and configuration of observability and CI/CD tools.
- Deployment of **Prometheus** for metrics collection and **Grafana** for visualization and dashboards, ensuring robust monitoring of the application and cluster.
- **ArgoCD** configuration to orchestrate Continuous Delivery (CD) pipelines, automating deployment and syncing the application state within the cluster.
- PowerShell scripts to automate common development and local deployment tasks.

---

## 🌳 Repository Structure

Refer to the detailed structure documentation here: [docs/detail_structure.md](https://www.google.com/search?q=docs/detail_structure.md)



├───.vscode
├───docs
│       detail\_structure.md
│
├───infra
│   └───terraform
│       │   .terraform.lock.hcl
│       │   main.tf
│       │   terraform.tfstate
│       │   terraform.tfstate.backup
│       │
│       ├───.terraform
│       │   ├───modules
│       │   │       modules.json
│       │   │
│       │   └───providers
│       │       ├───registry.opentofu.org
│       │       │   └───hashicorp
│       │       │       ├───helm
│       │       │       │   └───3.0.2
│       │       │       │       └───windows\_amd64
│       │       │       │               CHANGELOG.md
│       │       │       │               CHANGELOG\_GUIDE.md
│       │       │       │               LICENSE
│       │       │       │               README.md
│       │       │       │               terraform-provider-helm.exe
│       │       │       │
│       │       │       ├───kubernetes
│       │       │       │   └───2.37.1
│       │       │       │       └───windows\_amd64
│       │       │       │               CHANGELOG.md
│       │       │       │               CHANGELOG\_GUIDE.md
│       │       │       │               LICENSE
│       │       │       │               README.md
│       │       │       │               terraform-provider-kubernetes.exe
│       │       │       │
│       │       │       └───null
│       │       │           └───3.2.4
│       │       │               └───windows\_amd64
│       │       │                       CHANGELOG.md
│       │       │                       LICENSE
│       │       │                       README.md
│       │       │                       terraform-provider-null.exe
│       │       │
│       │       └───registry.terraform.io
│       │           └───hashicorp
│       │               └───aws
│       │                   └───5.100.0
│       │                       └───windows\_amd64
│       │                               LICENSE.txt
│       │                               terraform-provider-aws\_v5.100.0\_x5.exe
│       │
│       ├───environments
│       │   ├───dev
│       │   ├───prod
│       │   └───stage
│       └───modules
│           ├───argocd
│           │       main.tf
│           │       outputs.tf
│           │       values.yaml
│           │       variables.tf
│           │       version.tf
│           │
│           ├───fastapi-api
│           │   │   main.tf
│           │   │   outputs.tf
│           │   │   variables.tf
│           │   │   version.tf
│           │   │
│           │   └───ingress
│           │           main.tf
│           │
│           └───monitoring
│               │   main.tf
│               │   outputs.tf
│               │   values.yaml
│               │   variables.tf
│               │   version.tf
│               │
│               └───chart
├───kubernetes
│       deployment.yaml
│       service.yaml
│
├───scripts
│       install-opentofu.ps1
│
└───src
│   database.py
│   requirements.txt
│
├───api
│   │   main.py
│   │   **init**.py
│   │
│   ├───models
│   │   │   client.py
│   │   │   models.py
│   │   │
│   │   └───**pycache**
│   │           client.cpython-313.pyc
│   │
│   ├───static
│   │   └───css
│   │           style.css
│   │
│   ├───templates
│   │       about.html
│   │       base.html
│   │       clients.html
│   │       index.html
│   │
│   └───**pycache**
│           main.cpython-313.pyc
│           **init**.cpython-313.pyc
│
├───tests
└───**pycache**
database.cpython-313.pyc
security.cpython-313.pyc

````

---

## ⚡ Getting Started

### Prerequisites

Ensure you have the following tools installed:

- [**Git**](https://git-scm.com/): To clone the repository.
- [**Python 3.9+**](https://www.python.org/downloads/): For FastAPI development.
- [**Docker Desktop**](https://www.docker.com/products/docker-desktop/): With **Kubernetes enabled** in the settings.
- [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl/): Kubernetes CLI tool.
- [**OpenTofu**](https://opentofu.org/docs/): To provision infrastructure.
- [**PowerShell**](https://docs.microsoft.com/en-us/powershell/): To run automation scripts.

### Local Environment Setup

1. **Clone the repository:**

   ```bash
   git clone https://github.com/nsw78/ter-k8s-api.git
   cd ter-k8s-api
````

2. **Create the folder structure:**

   (If you have not used the folder creation script before, run `scripts/create_project_structure.ps1` or use an appropriate `mkdir` command.)

3. **Setup kubectl autocomplete in PowerShell (if not done yet):**

   Run the script:

   ```powershell
   .\scripts\setup_local_env.ps1
   ```

4. **Set up Python virtual environment:**

   ```powershell
   python -m venv .venv
   .\.venv\Scripts\Activate.ps1  # Windows PowerShell
   # source ./.venv/bin/activate  # Bash/WSL
   ```

5. **Install Python dependencies:**

   ```powershell
   pip install -r src/requirements.txt
   ```

### Running the Application Locally (Development)

To run the API in development mode (with hot-reload):

1. Activate your Python virtual environment.

2. Navigate to the `src/` directory:

   ```powershell
   cd src
   ```

3. Run Uvicorn:

   ```powershell
   uvicorn api.main:app --reload --host 0.0.0.0 --port 8000
   ```

4. Access the API in your browser at `http://localhost:8000`

5. Explore the **interactive API documentation (Swagger UI)** at `http://localhost:8000/docs`.

6. Access the OpenAPI JSON specification at `http://localhost:8000/openapi.json`.

---

## ☁️ Deploying to Local Kubernetes (Docker Desktop)

This project includes deployment of the application, Prometheus, Grafana, and ArgoCD on your local Kubernetes cluster, all managed via OpenTofu.

1. **Build the Docker image for the API:**

   ```powershell
   .\scripts\build_docker_image.ps1
   ```

2. **Initialize and apply OpenTofu for the local environment:**

   ```powershell
   cd infra\opentofu\environments\local
   opentofu init
   opentofu apply -auto-approve
   ```

3. **Verify deployment:**

   ```powershell
   kubectl get pods -n default
   kubectl get svc -n default
   kubectl get ingress -n default
   ```

   Wait for pods to be in `Running` status.

4. Access URLs depend on your Ingress setup. If using Docker Desktop’s default Kubernetes Ingress (usually `localhost`), access the app at `http://localhost:<ingress_port>` or `http://localhost/<ingress_path>`.

* **Prometheus:** Typically exposed via Ingress or port-forwarding. Check OpenTofu logs or Kubernetes services for details.
* **Grafana:** Typically exposed via Ingress or port-forwarding. Default URL and credentials can be found in Helm chart docs or OpenTofu outputs.
* **ArgoCD:** Accessible via Ingress or port-forwarding. Default credentials and URLs are in Helm chart docs or OpenTofu outputs.

---

## 🧹 Cleaning Up Local Environment

To destroy all infrastructure created by OpenTofu:

```powershell
cd infra\opentofu\environments\local
opentofu destroy -auto-approve
```

---

If you want me to help add badges, contribution guidelines, or anything else, just ask!
