ğŸš€ Using OpenTofu + Kubernetes + FastAPI + Grafana + Prometheus + ArgoCD ğŸš€
Welcome to ter-k8s-api! This repository contains a sample FastAPI application and all the infrastructure as code needed to deploy it on a local Kubernetes cluster (Docker Desktop).

---

```markdown
# ğŸš€ Using OpenTofu + Kubernetes + FastAPI + Grafana + Prometheus + ArgoCD ğŸš€

Welcome to **ter-k8s-api**! This repository contains a sample **FastAPI** application and all the infrastructure as code required to deploy it on a local Kubernetes cluster (Docker Desktop).

---

## ğŸ“š Project Overview

This project demonstrates a well-organized directory structure for Python applications using FastAPI, Docker, OpenTofu, and Kubernetes. It includes:

- A simple **FastAPI API** for customer management, supporting **create**, read, update, and delete operations.
- **Interactive API documentation with Swagger UI (OpenAPI)**, auto-generated by FastAPI, enabling easy exploration and testing of endpoints.
- Jinja2 templates and static files for a basic web interface.
- A `Dockerfile` to containerize the application.
- **OpenTofu** modules defining Kubernetes infrastructure, including API deployment, monitoring, and configuration of observability and CI/CD tools.
- Deployment of **Prometheus** for metrics collection and **Grafana** for visualization and dashboards, ensuring robust monitoring of the application and cluster.
- **ArgoCD** configuration to orchestrate Continuous Delivery (CD) pipelines, automating deployment and syncing the application state within the cluster.
- PowerShell scripts to automate common development and local deployment tasks.

---

## ğŸŒ³ Repository Structure

Refer to the detailed structure documentation here: [docs/detail_structure.md](https://www.google.com/search?q=docs/detail_structure.md)



â”œâ”€â”€â”€.vscode
â”œâ”€â”€â”€docs
â”‚       detail\_structure.md
â”‚
â”œâ”€â”€â”€infra
â”‚   â””â”€â”€â”€terraform
â”‚       â”‚   .terraform.lock.hcl
â”‚       â”‚   main.tf
â”‚       â”‚   terraform.tfstate
â”‚       â”‚   terraform.tfstate.backup
â”‚       â”‚
â”‚       â”œâ”€â”€â”€.terraform
â”‚       â”‚   â”œâ”€â”€â”€modules
â”‚       â”‚   â”‚       modules.json
â”‚       â”‚   â”‚
â”‚       â”‚   â””â”€â”€â”€providers
â”‚       â”‚       â”œâ”€â”€â”€registry.opentofu.org
â”‚       â”‚       â”‚   â””â”€â”€â”€hashicorp
â”‚       â”‚       â”‚       â”œâ”€â”€â”€helm
â”‚       â”‚       â”‚       â”‚   â””â”€â”€â”€3.0.2
â”‚       â”‚       â”‚       â”‚       â””â”€â”€â”€windows\_amd64
â”‚       â”‚       â”‚       â”‚               CHANGELOG.md
â”‚       â”‚       â”‚       â”‚               CHANGELOG\_GUIDE.md
â”‚       â”‚       â”‚       â”‚               LICENSE
â”‚       â”‚       â”‚       â”‚               README.md
â”‚       â”‚       â”‚       â”‚               terraform-provider-helm.exe
â”‚       â”‚       â”‚       â”‚
â”‚       â”‚       â”‚       â”œâ”€â”€â”€kubernetes
â”‚       â”‚       â”‚       â”‚   â””â”€â”€â”€2.37.1
â”‚       â”‚       â”‚       â”‚       â””â”€â”€â”€windows\_amd64
â”‚       â”‚       â”‚       â”‚               CHANGELOG.md
â”‚       â”‚       â”‚       â”‚               CHANGELOG\_GUIDE.md
â”‚       â”‚       â”‚       â”‚               LICENSE
â”‚       â”‚       â”‚       â”‚               README.md
â”‚       â”‚       â”‚       â”‚               terraform-provider-kubernetes.exe
â”‚       â”‚       â”‚       â”‚
â”‚       â”‚       â”‚       â””â”€â”€â”€null
â”‚       â”‚       â”‚           â””â”€â”€â”€3.2.4
â”‚       â”‚       â”‚               â””â”€â”€â”€windows\_amd64
â”‚       â”‚       â”‚                       CHANGELOG.md
â”‚       â”‚       â”‚                       LICENSE
â”‚       â”‚       â”‚                       README.md
â”‚       â”‚       â”‚                       terraform-provider-null.exe
â”‚       â”‚       â”‚
â”‚       â”‚       â””â”€â”€â”€registry.terraform.io
â”‚       â”‚           â””â”€â”€â”€hashicorp
â”‚       â”‚               â””â”€â”€â”€aws
â”‚       â”‚                   â””â”€â”€â”€5.100.0
â”‚       â”‚                       â””â”€â”€â”€windows\_amd64
â”‚       â”‚                               LICENSE.txt
â”‚       â”‚                               terraform-provider-aws\_v5.100.0\_x5.exe
â”‚       â”‚
â”‚       â”œâ”€â”€â”€environments
â”‚       â”‚   â”œâ”€â”€â”€dev
â”‚       â”‚   â”œâ”€â”€â”€prod
â”‚       â”‚   â””â”€â”€â”€stage
â”‚       â””â”€â”€â”€modules
â”‚           â”œâ”€â”€â”€argocd
â”‚           â”‚       main.tf
â”‚           â”‚       outputs.tf
â”‚           â”‚       values.yaml
â”‚           â”‚       variables.tf
â”‚           â”‚       version.tf
â”‚           â”‚
â”‚           â”œâ”€â”€â”€fastapi-api
â”‚           â”‚   â”‚   main.tf
â”‚           â”‚   â”‚   outputs.tf
â”‚           â”‚   â”‚   variables.tf
â”‚           â”‚   â”‚   version.tf
â”‚           â”‚   â”‚
â”‚           â”‚   â””â”€â”€â”€ingress
â”‚           â”‚           main.tf
â”‚           â”‚
â”‚           â””â”€â”€â”€monitoring
â”‚               â”‚   main.tf
â”‚               â”‚   outputs.tf
â”‚               â”‚   values.yaml
â”‚               â”‚   variables.tf
â”‚               â”‚   version.tf
â”‚               â”‚
â”‚               â””â”€â”€â”€chart
â”œâ”€â”€â”€kubernetes
â”‚       deployment.yaml
â”‚       service.yaml
â”‚
â”œâ”€â”€â”€scripts
â”‚       install-opentofu.ps1
â”‚
â””â”€â”€â”€src
â”‚   database.py
â”‚   requirements.txt
â”‚
â”œâ”€â”€â”€api
â”‚   â”‚   main.py
â”‚   â”‚   **init**.py
â”‚   â”‚
â”‚   â”œâ”€â”€â”€models
â”‚   â”‚   â”‚   client.py
â”‚   â”‚   â”‚   models.py
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€**pycache**
â”‚   â”‚           client.cpython-313.pyc
â”‚   â”‚
â”‚   â”œâ”€â”€â”€static
â”‚   â”‚   â””â”€â”€â”€css
â”‚   â”‚           style.css
â”‚   â”‚
â”‚   â”œâ”€â”€â”€templates
â”‚   â”‚       about.html
â”‚   â”‚       base.html
â”‚   â”‚       clients.html
â”‚   â”‚       index.html
â”‚   â”‚
â”‚   â””â”€â”€â”€**pycache**
â”‚           main.cpython-313.pyc
â”‚           **init**.cpython-313.pyc
â”‚
â”œâ”€â”€â”€tests
â””â”€â”€â”€**pycache**
database.cpython-313.pyc
security.cpython-313.pyc

````

---

## âš¡ Getting Started

### Prerequisites

Ensure you have the following tools installed:

- [**Git**](https://git-scm.com/): To clone the repository.
- [**Python 3.9+**](https://www.python.org/downloads/): For FastAPI development.
- [**Docker Desktop**](https://www.docker.com/products/docker-desktop/): With **Kubernetes enabled** in the settings.
- [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl/): Kubernetes CLI tool.
- [**OpenTofu**](https://opentofu.org/docs/): To provision infrastructure.
- [**PowerShell**](https://docs.microsoft.com/en-us/powershell/): To run automation scripts.

### Local Environment Setup

1. **Clone the repository:**

   ```bash
   git clone https://github.com/nsw78/ter-k8s-api.git
   cd ter-k8s-api
````

2. **Create the folder structure:**

   (If you have not used the folder creation script before, run `scripts/create_project_structure.ps1` or use an appropriate `mkdir` command.)

3. **Setup kubectl autocomplete in PowerShell (if not done yet):**

   Run the script:

   ```powershell
   .\scripts\setup_local_env.ps1
   ```

4. **Set up Python virtual environment:**

   ```powershell
   python -m venv .venv
   .\.venv\Scripts\Activate.ps1  # Windows PowerShell
   # source ./.venv/bin/activate  # Bash/WSL
   ```

5. **Install Python dependencies:**

   ```powershell
   pip install -r src/requirements.txt
   ```

### Running the Application Locally (Development)

To run the API in development mode (with hot-reload):

1. Activate your Python virtual environment.

2. Navigate to the `src/` directory:

   ```powershell
   cd src
   ```

3. Run Uvicorn:

   ```powershell
   uvicorn api.main:app --reload --host 0.0.0.0 --port 8000
   ```

4. Access the API in your browser at `http://localhost:8000`

5. Explore the **interactive API documentation (Swagger UI)** at `http://localhost:8000/docs`.

6. Access the OpenAPI JSON specification at `http://localhost:8000/openapi.json`.

---

## â˜ï¸ Deploying to Local Kubernetes (Docker Desktop)

This project includes deployment of the application, Prometheus, Grafana, and ArgoCD on your local Kubernetes cluster, all managed via OpenTofu.

1. **Build the Docker image for the API:**

   ```powershell
   .\scripts\build_docker_image.ps1
   ```

2. **Initialize and apply OpenTofu for the local environment:**

   ```powershell
   cd infra\opentofu\environments\local
   opentofu init
   opentofu apply -auto-approve
   ```

3. **Verify deployment:**

   ```powershell
   kubectl get pods -n default
   kubectl get svc -n default
   kubectl get ingress -n default
   ```

   Wait for pods to be in `Running` status.

4. Access URLs depend on your Ingress setup. If using Docker Desktopâ€™s default Kubernetes Ingress (usually `localhost`), access the app at `http://localhost:<ingress_port>` or `http://localhost/<ingress_path>`.

* **Prometheus:** Typically exposed via Ingress or port-forwarding. Check OpenTofu logs or Kubernetes services for details.
* **Grafana:** Typically exposed via Ingress or port-forwarding. Default URL and credentials can be found in Helm chart docs or OpenTofu outputs.
* **ArgoCD:** Accessible via Ingress or port-forwarding. Default credentials and URLs are in Helm chart docs or OpenTofu outputs.

---

## ğŸ§¹ Cleaning Up Local Environment

To destroy all infrastructure created by OpenTofu:

```powershell
cd infra\opentofu\environments\local
opentofu destroy -auto-approve
```

---

If you want me to help add badges, contribution guidelines, or anything else, just ask!
